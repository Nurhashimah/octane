.navbar
  %ul.nav
    %li= link_to(fa_icon("print", text: (t 'actions.print')), "javascript:print()")

- provide(:title, 'Depot Fuel - Usage')
- model_class = DepotFuel
.page-header

  %h1= t 'report.depot_fuel_usage', :default => model_class.model_name.human  
  
.row-fluid
  .block
    .block-heading.tool_bar
      .col-sm-6
        = form_for :search, :url => depot_monthly_usage_depot_fuels_path, :role => "form", class: "form-inline" do |f|
          .form-group
            #datepicker.input-daterange.input-group
              .input-group-addon From
              = f.text_field :issue_date, :name => "search[start_date]" , type: "text", class: "form-control", 'data-behaviour' => 'datepicker_before', placeholder: @start_from,  value:  (@params_start_date  = params[:search].try(:[], :start_date))
              .input-group-addon To
              = f.text_field :issue_date, :name => "search[end_date]"   , type: "text", class: "form-control", 'data-behaviour' => 'datepicker_before', placeholder: @end_on,      value: (@params_end_date    = params[:search].try(:[], :end_date))
              %span.input-group-btn
                %button.btn.btn-default{:type => "submit", :style => "height:34px;"}
                  %i.glyphicon.glyphicon-search

%BR
%BR
  %h4
    - if params[:search].present? 
      - if !params[:search][:start_date].present? && !params[:search][:end_date].present?
        = t 'report.depot_usage_current'
      - else
        = t 'report.depot_usage_for'
        - if params[:search][:start_date].present? 
          = Date.parse(params[:search][:start_date]).strftime('%d-%m-%Y')
        - else
          = (Date.today.beginning_of_month).strftime('%d-%m-%Y')
        \-
        - if params[:search][:end_date].present?
          = Date.parse(params[:search][:end_date]).strftime('%d-%m-%Y')
        - else
          = (Date.today.end_of_day).strftime('%d-%m-%Y')
    - else
      = t 'report.depot_usage_current'

- days_count=Time.days_in_month(Date.today.month, Date.today.year)
- fuel_types=FuelType.where(shortname: ['PETROL', 'DIESEL', 'AVTUR', 'AVCAT'])
- fuel_types.each do |ftype|
  =ftype.name
  %table.table.table-bordered
    %thead
      %tr
        %th No
        %th= t 'depot_fuels.unit_id'
        %th= t 'depot_fuels.issue_date'
        %th= t 'depot_fuels.start_bal'
        %th= t 'depot_fuels.received' 
        %th= t 'depot_fuels.issued' 
        %th= t 'fuel_balances.current'
        %th= t 'depot_fuels.usage_average'
    %tbody
      - @monthly_usage.sort_by{|x|[x.unit_id, x.issue_date]}.each_with_index do |depot_fuel, index|
        - tank_ids=ftype.fuel_tanks.pluck(:id)
        - cache "depotfuel-#{depot_fuel.id}/#{ftype.name}-#{depot_fuel.updated_at.to_i}" do
          /display depot_fuel lines accordingly
          %tr
            %td=index+1
            %td= check_kin {depot_fuel.depot.unit_details}
            %td= check_kin {l(depot_fuel.issue_date)}
            %td.right=DepotFuel.where( "issue_date < ? ", depot_fuel.issue_date).where(unit_id: depot_fuel.unit_id).last.fuel_balances.where(fuel_tank_id: tank_ids).sum(:current) rescue 0
            %td.right=depot_fuel.fuel_supplieds.where(fuel_type_id: ftype).sum(:quantity)
            %td.right=issueds=depot_fuel.fuel_issueds.where(fuel_type_id: ftype).sum(:quantity)
            %td.right=depot_fuel.fuel_balances.where(fuel_tank_id: tank_ids).sum(:current) 
            %td.right=number_with_precision(issueds/days_count, precision: 2)
        
      /Display - Total lines   
      - a=0
      -@monthly_usage.each{|x|a+=DepotFuel.where( "issue_date < ? ", x.issue_date).where(unit_id: x.unit_id).last.fuel_balances.where(fuel_tank_id:  ftype.fuel_tanks.pluck(:id)).sum(:current) rescue 0}
      %tr
        %th.right{colspan: 3}= (t 'depot_fuels.total').upcase
        %td.right=a
        %td.right=FuelSupplied.where(fuel_type_id: ftype).where(depot_fuel_id: @monthly_usage.pluck(:id)).sum(:quantity)
        %td.right=total_issueds=FuelIssued.where(fuel_type_id: ftype).where(depot_fuel_id: @monthly_usage.pluck(:id)).sum(:quantity)
        %td.right=FuelBalance.where(fuel_tank_id: ftype.fuel_tanks.pluck(:id)).where(depot_fuel_id: @monthly_usage.pluck(:id)).sum(:current)
        %td.right=number_with_precision(total_issueds/days_count, precision: 2) 
      

/ref UAT : set to 31days / current month